<%- include('navbar.ejs') %>

<div class="container user_cart">
  <div class="row g-4">
    <!-- Cart Items -->
    <div class="col-md-8">
      <div class="cart-table-wrapper" style="max-height: 400px; overflow-y: auto;">
        <table class="table cart-table align-middle">
          <thead class="table-light sticky-top bg-white" style="z-index: 1;">
            <tr>
              <th></th>
              <th>Product</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Subtotal</th>
            </tr>
          </thead>

          <% if (cartData.length === 0) { %>
            <tbody id="cart-items">
              <tr>
                <td colspan="5" class="text-center py-5">
                  <h4>ðŸ›’ Your cart is empty</h4>
                  <a href="/" class="btn btn-primary mt-3">Go to Select Files</a>
                </td>
              </tr>
            </tbody>
          <% } else { %>
            <tbody id="cart-items">
              <% for (let i = 0; i < cartData.length; i++) {
                  var item = cartData[i];
                  var total = item.final_price * item.qty;
              %>
                <tr data-price="<%= item.stock === 'outstock' ? 0 : item.final_price %>" data-cartid="<%= item.cart_id %>" class="<%= item.stock === 'outstock' ? 'text-danger' : '' %>">
                  <td>
                    <a href="/delete_cart/<%= item.cart_id %>" class="remove-btn text-danger fs-3" onclick="return confirm('Are you sure you want to remove this item?')">
                      &times;
                    </a>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                     <a href="/process_card/<%= item.file_id %>"> <img src="/admin/uploads/<%= item.file_img %>" alt="" width="60" height="60" style="object-fit: cover;"></a>
                      <div class="product-name">
                        <%= item.design_name %> | #00<%= item.file_id %><br>
                        <% if (item.stock === 'outstock') { %>
                          <span class="badge bg-danger">Out of Stock</span>
                        <% } %>
                      </div>
                    </div>
                  </td>
                  <td>â‚¹<%= item.stock === 'outstock' ? '0.00' : item.final_price + '.00' %></td>
                  <td>
                    <% if (item.stock === 'outstock') { %>
                      <div class="text-muted">N/A</div>
                    <% } else { %>
                      <div class="qty-control d-flex align-items-center gap-1">
                        <button onclick="updateQty(this, -1, '<%= item.cart_id %>')" class="btn btn-outline-secondary btn-sm">âˆ’</button>
                        <input type="text" readonly value="<%= item.qty %>" class="form-control form-control-sm text-center" style="width: 50px;">
                        <button onclick="updateQty(this, 1, '<%= item.cart_id %>')" class="btn btn-outline-secondary btn-sm">+</button>
                      </div>
                    <% } %>
                  </td>
                  <td class="item-subtotal">â‚¹<%= item.stock === 'outstock' ? '0.00' : total + '.00' %></td>
                </tr>
              <% } %>
            </tbody>
          <% } %>

        </table>
      </div>
    </div>

    <!-- Cart Totals -->
    <div class="col-md-4">
      <div class="cart-totals border p-3 rounded shadow-sm">
        <h5>CART TOTALS</h5>
        <hr>
        <p>Subtotal: <strong>â‚¹<span id="subtotal">0.00</span></strong></p>
        <p>Total: <strong>â‚¹<span id="total">0.00</span></strong></p>
        <%if(total > 0 && item.stock=='instock'){%>
        <button class="checkout-btn btn btn-success w-100 mt-2"><a href="/cart_checkout" class="text-dark">Proceed to Checkout</a></button>
        <%}else{%>
 <button disabled class="checkout-btn btn btn-success w-100 mt-2"><a href="/cart_checkout" class="text-dark">Proceed to Checkout</a></button>
          <%}%>
        <p class="note text-muted mt-2 small">* Taxes and shipping calculated at checkout</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Calculate cart subtotal and total
  function calcCart() {
    let subtotal = 0;
    document.querySelectorAll('#cart-items tr[data-price]').forEach(row => {
      const price = parseFloat(row.getAttribute('data-price'));
      const qtyInput = row.querySelector('input');
      const qty = qtyInput ? parseInt(qtyInput.value) : 0;
      const sub = price * qty;
      row.querySelector('.item-subtotal').textContent = `â‚¹${sub.toFixed(2)}`;
      subtotal += sub;
    });
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('total').textContent = subtotal.toFixed(2);
  }

  // Update quantity via AJAX
  function updateQty(btn, delta, cartId) {
    const input = btn.parentElement.querySelector('input');
    let qty = parseInt(input.value);
    qty += delta;
    if (qty < 1) qty = 1;
    input.value = qty;

    fetch(`/update_cart_qty/${cartId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ qty })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        calcCart();
      } else {
        alert('Failed to update quantity');
      }
    })
    .catch(err => {
      console.error(err);
      alert('Error updating cart');
    });
  }

  window.onload = calcCart;
</script>

<%- include('footer.ejs') %>
