<%- include("navbar.ejs") %>

<section class="login-sec">
  <div class="container mt-0">
    <div class="row mt-5 login-card-main">
      <div class="col-md-12">                
        <div class="login-card">
          <h2>Login</h2>
          <form id="loginForm" enctype="multipart/form-data">
            <div class="form-group position-relative">
              <i class="bi bi-person-fill"></i>
              <input type="text" id="loginEmail" placeholder="Username or Email" name="login_identifier" required>
            </div>

            <div class="form-group position-relative">
              <i class="bi bi-lock-fill"></i>
              <input type="password" id="loginPassword" placeholder="Password" name="password" required>
              <i class="bi bi-eye-slash-fill toggle-password" onclick="toggleLoginPassword()" style="position:absolute; left:280px; top:50%; transform:translateY(-50%); cursor:pointer;"></i>
            </div>

            <!-- Message placeholders -->
            <p id="errorMsg" style="color: #ff4d4d; font-size: 0.9rem; display: none; text-align: center;">
              Invalid email or password. Please try again.
            </p>
            <p id="successMsg" style="color: #28a745; font-size: 0.9rem; display: none; text-align: center;">
              Login successful! Redirecting...
            </p>

            <button type="submit" class="login-btn">Login</button>

            <div class="forgot">
              <span class="text-white">Don't have an account? </span> <a href="/register">Sign Up</a><br>
              <a href="/">Forgot Password?</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- JavaScript -->
<script>
  function toggleLoginPassword() {
    const passwordInput = document.getElementById("loginPassword");
    const toggleIcon = passwordInput.nextElementSibling;
    const isPassword = passwordInput.type === "password";

    passwordInput.type = isPassword ? "text" : "password";
    toggleIcon.classList.toggle("bi-eye-fill");
    toggleIcon.classList.toggle("bi-eye-slash-fill");
  }

  document.getElementById("loginForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Prevent form from reloading

    const login_identifier = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    const errorMsg = document.getElementById("errorMsg");
    const successMsg = document.getElementById("successMsg");

    // Send login data via AJAX
    const response = await fetch("/user_login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ login_identifier, password })
    });

    const result = await response.json();

    if (result.success) {
      errorMsg.style.display = "none";
      successMsg.style.display = "block";
      setTimeout(() => {
        window.location.href = result.redirect || "/";
      }, 2000);
    } else {
      successMsg.style.display = "none";
      errorMsg.style.display = "block";
    }
  });
</script>

<%- include("footer.ejs") %>
