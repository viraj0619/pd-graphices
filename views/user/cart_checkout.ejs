<%-include('navbar.ejs')%>

<div class="container checkout-container">
  <form action="process_checkout" method="POST" >
  <div class="row g-5">
    <!-- Billing Info -->
    <div class="col-md-7">
      <h3>Billing Information</h3>

        <div class="row">
          
          <div class="col-md-6 mb-3">
            <label for="fname">First Name</label>
            <input type="text" id="lname" class="input-field" name="first_name" placeholder="" value="<%=userData[0].firstname%>" required>
          </div>
           <div class="col-md-6 mb-3">
            <label for="lname">Last Name</label>
            <input type="text" id="lname" class="input-field" name="last_name" placeholder="" value="<%=userData[0].lastname%>" required>
          </div>
        </div>
        <div class="mb-3">
          <label for="email">Email Address</label>
          <input type="email" id="email" class="input-field" name="user_email" value="<%=userData[0].email%>" placeholder="example@email.com" required>
        </div>
        <div class="mb-3">
          <label for="phone">Phone Number</label>
          <input type="tel" id="" class="input-field" name="user_mobile" value="<%=userData[0].user_mobile%>" placeholder="Enter mobile" required>
        </div>

        <!-- Country -->
        <div class="mb-3">
          <label for="country">Country</label>
                      <input type="text" id="country" class="input-field" name="country" placeholder="Enter country" required value="India">
        </div>

        <!-- State -->
        <div class="mb-3">
          <label for="state">State</label>
         <input type="text" id="state" class="input-field" name="state" placeholder="Enter state" required>
        </div>

        <!-- District -->
        <div class="mb-3">
          <label for="district">District</label>
         <input type="text" id="district" class="input-field" name="district" placeholder="Enter district" required>
        </div>
      </form>
    </div>

    <!-- Order Summary -->
<div class="col-md-5">
  <h3>Order Summary</h3>
  <div class="summary-box">
    <h5>Products</h5>

    <% 
      let subtotal = 0;
      let totalDiscount = 0;
      let grandTotal = 0;

      for (let i = 0; i < cartData.length; i++) {
        let qty = cartData[i].qty || 1;
        let itemSubtotal = cartData[i].file_price * qty;
        let itemDiscount = (cartData[i].file_price - cartData[i].final_price) * qty;
        let itemFinal = cartData[i].final_price * qty;

        subtotal += itemSubtotal;
        totalDiscount += itemDiscount;
        grandTotal += itemFinal;
    %>
      <p>
        <%= cartData[i].design_name %> #00<%= cartData[i].file_id %> 
        <strong>× <%= qty %></strong>
        <span class="float-end">₹<%= itemFinal %></span>
      </p>
    <% } %>

    <hr>
    <p><strong>Subtotal</strong> 
      <span class="float-end">₹<%= subtotal %></span>
    </p>
    <p><strong>Shipping</strong> 
      <span class="float-end">₹0</span>
    </p>
    <p><strong>Discount</strong> 
      <span class="float-end">-₹<%= totalDiscount %></span>
    </p>

    <hr>
    <p><strong>Total</strong> 
      <span class="float-end">₹<%= grandTotal %></span>
    </p>
    <button class="checkout-btn mt-3">Proceed to Payment</button>
  </div>
</div>

  </div>
  </form>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
  // Country Change → Load States
  $("#country").change(function() {
    let country = $(this).val();
    $("#state").html('<option value="">Loading...</option>');
    $("#district").html('<option value="">-- Select District --</option>');

    $.ajax({
      url: "https://countriesnow.space/api/v0.1/countries/states",
      method: "POST",
      data: JSON.stringify({ country }),
      contentType: "application/json",
      success: function(res) {
        $("#state").html('<option value="">-- Select State --</option>');
        res.data.states.forEach(state => {
          $("#state").append(`<option value="${state.name}">${state.name}</option>`);
        });
      }
    });
  });

  // State Change → Load Districts (Cities)
  $("#state").change(function() {
    let country = $("#country").val();
    let state = $(this).val();
    $("#district").html('<option value="">Loading...</option>');

    $.ajax({
      url: "https://countriesnow.space/api/v0.1/countries/state/cities",
      method: "POST",
      data: JSON.stringify({ country, state }),
      contentType: "application/json",
      success: function(res) {
        $("#district").html('<option value="">-- Select District --</option>');
        res.data.forEach(city => {
          $("#district").append(`<option value="${city}">${city}</option>`);
        });
      }
    });
  });
});
</script>

<%-include('footer.ejs')%>
