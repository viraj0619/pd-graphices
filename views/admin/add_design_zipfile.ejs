<%- include('navbar.ejs') %>

<section class="form-group">
  <div class="container">
    <div class="form-wrapper">
      <h2>Add Design Zip File</h2>

      <!-- Progress Bar -->
      <div id="progressWrapper" style="display:none; margin-bottom: 15px;">
        <div style="width: 100%; background: #f3f3f3; border-radius: 5px;">
          <div id="progressBar" style="width: 0%; height: 20px; background: #28a745; border-radius: 5px;"></div>
        </div>
        <p id="progressText" style="margin-top: 5px;">0%</p> 
      </div>

      <!-- Upload Form -->
      <form id="uploadForm">
        <div class="form-group">
          <label for="main_file">Design File (zip only, max 2GB)</label>
          <input type="file" name="main_file" id="main_file" accept=".zip" required>
        </div>
        <input type="hidden" name="fileId" id="fileId" value="<%= fileId %>">
        <button type="submit" class="submit-btn">Add File</button>
      </form>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById("uploadForm");
  const progressWrapper = document.getElementById("progressWrapper");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const fileInput = document.getElementById("main_file");
    const file = fileInput.files[0];
    const fileId = document.getElementById("fileId").value;

    // ✅ Check file size limit (2GB = 2 * 1024 * 1024 * 1024 bytes)
    if (file.size > 2 * 1024 * 1024 * 1024) {
      alert("❌ File size must be less than 2 GB.");
      return;
    }

    const formData = new FormData();
    formData.append("main_file", file);

    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener("progress", (e) => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressWrapper.style.display = "block";
        progressBar.style.width = percent + "%";
        progressText.innerText = percent + "%";
      }
    });

    xhr.onload = () => {
      if (xhr.status === 200) {
        alert("✅ File uploaded successfully!");
        window.location.href = "/admin/file_list";
      } else {
        alert("❌ Upload failed: " + xhr.responseText);
      }
    };

    xhr.onerror = () => {
      alert("❌ Upload error.");
    };

    xhr.open("POST", `/admin/uploadzip/${fileId}`);
    xhr.send(formData);
  });
</script>

<%- include('footer.ejs') %>
