<%- include('navbar.ejs') %>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<div class="container my-4">
    <div class="row mb-3">
        <div>
            <input type="text" class="form-control search-box shadow-sm" id="fileSearch" placeholder="üîç Search by ID..." onkeyup="searchTable()">
        </div>
    </div>
    <h2 class="mb-4 text-center fw-bold text-primary">üìÅ Uploaded Files</h2>

    <!-- ‚úÖ Scroll Wrapper Restored -->
    <div class="table-responsive shadow-lg rounded-3">
        <table class="table table-bordered table-hover align-middle text-center" id="filesTable">
            <thead class="table-dark">
                <tr>
                    <th>No.</th>
                    <th>#ID</th>
                    <th>Status</th>
                    <th>Action</th>
                    <th>Image</th>
                    <th>Design Name</th>
                    <th>Categories</th>
                    <th>Price (‚Çπ)</th>
                    <th>Discount (%)</th>
                    <th>Final Price (‚Çπ)</th>
                    <th>Main File</th>
                    <th>Stock</th>
                    <th>Description</th>
                    <th>Date</th>
                    <th>View</th>
                    <th>Purchased</th>
                </tr>
            </thead>
            <tbody>
                <% for (let i = 0; i < filesData.length; i++) { %>
                <tr>
                    <td><%= i + 1 %></td>
                    <td>#00<%= filesData[i].file_id %></td>

                    <!-- ‚úÖ Status Button -->
                    <td>
                        <div class="statusButton">
                            <label class="switch">
                                <input
                                    type="checkbox"
                                    class="statusToggle"
                                    <%= filesData[i].status === 'active' ? 'checked' : '' %>
                                    data-id="<%= filesData[i].file_id %>"
                                    onchange="toggleStatus(this)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </td>

                    <!-- ‚úÖ Action Buttons -->
                    <td class="action-btns">
                        <a href="/admin/edit_design/<%= filesData[i].file_id %>" class="btn btn-sm btn-warning" title="Edit">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="/admin/delete_design/<%= filesData[i].file_id %>" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Delete Design')">
                            <i class="bi bi-trash3"></i>
                        </a>
                    </td>

                    <!-- ‚úÖ Image -->
                    <td>
                        <img src="/admin/uploads/<%= filesData[i].file_img %>" width="60" height="60" class="img-thumbnail rounded shadow-sm">
                    </td>
                    <td><%= filesData[i].design_name %></td>
                    <td><%= filesData[i].categories %></td>
                    <td class="fw-bold text-success">‚Çπ<%= filesData[i].file_price %></td>
                    <td class="text-danger"><%= filesData[i].file_dis %>%</td>
                    <td class="fw-bold text-primary">‚Çπ<%= filesData[i].final_price %></td>

                    <!-- ‚úÖ Main File -->
                    <td>
                        <%if(filesData[i].stock=='instock'){%>
                        <a href="/designZipfiles/<%= filesData[i].main_file %>" download class="btn btn-sm btn-primary shadow-sm" title="Download">
                            <i class="bi bi-download"></i>
                        </a>
                        <%}else{%>
                            <a href="/admin/add_design_zipfile/<%= filesData[i].file_id %>" class="btn btn-sm btn-outline-primary">Add File</a>
                        <%}%>
                    </td>

                    <!-- ‚úÖ Stock -->
                    <%if(filesData[i].stock=='instock'){%>
                    <td class="text-success fw-bold"><%= filesData[i].stock %></td>
                    <%}else{%>
                    <td class="text-danger fw-bold"><%= filesData[i].stock %></td>
                    <%}%>

                    <!-- ‚úÖ Description -->
                    <td class="fullDescription"><%= filesData[i].file_des %></td>

                    <td><span class="badge bg-secondary"><%= filesData[i].date %></span></td>
                    <td><i class="bi bi-eye text-info"></i> <%= filesData[i].file_view %></td>
                    <td><span class="badge bg-success"><%= filesData[i].file_perchesed %></span></td>
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- ‚úÖ Pagination -->
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        <% 
            let startPage = Math.max(1, currentPage - 1); 
            let endPage = Math.min(totalPages, currentPage + 1);
            if (currentPage === 1) { endPage = Math.min(totalPages, 3); }
            if (currentPage === totalPages) { startPage = Math.max(1, totalPages - 2); }
        %>

        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="/admin/file_list?page=<%= currentPage - 1 %>">Previous</a>
        </li>

        <% for(let i = startPage; i <= endPage; i++){ %>
            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a class="page-link" href="/admin/file_list?page=<%= i %>"><%= i %></a>
            </li>
        <% } %>

        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="/admin/file_list?page=<%= currentPage + 1 %>">Next</a>
        </li>
    </ul>
</nav>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // ‚úÖ AJAX toggle status
    function toggleStatus(checkbox) {
        const designId = checkbox.getAttribute("data-id");
        const newStatus = checkbox.checked ? "active" : "inactive";

        $.ajax({
            url: "/admin/design_update_status",
            method: "POST",
            data: { id: designId, status: newStatus },
            success: function (res) {
                console.log("Server Response:", res.message);
                if (!res.success) {
                    alert("Failed to update status: " + res.message);
                    checkbox.checked = !checkbox.checked;
                }
            },
            error: function (xhr, status, error) {
                alert("Error updating status. Please check console.");
                console.error("AJAX Error:", status, error);
                console.error("Response Text:", xhr.responseText);
                checkbox.checked = !checkbox.checked;
            }
        });
    }

    // ‚úÖ Search by ID
    function searchTable() {
        const input = document.getElementById("fileSearch");
        const filter = input.value.toLowerCase();
        const table = document.getElementById("filesTable");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) {
            let td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                const txtValue = td.textContent || td.innerText;
                tr[i].style.display = txtValue.toLowerCase().includes(filter) ? "" : "none";
            }
        }
    }

    // ‚úÖ Limit description to 6 words
    document.querySelectorAll(".fullDescription").forEach((descElement) => {
        const fullText = descElement.textContent.trim();
        const words = fullText.split(" ");
        if (words.length > 6) {
            const shortText = words.slice(0, 6).join(" ") + "...";
            descElement.textContent = shortText;
        }
    });
</script>

<%- include('footer.ejs') %>
